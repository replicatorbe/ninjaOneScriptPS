# Script bas√© sur la m√©thode PersonalizationCSP
# Adapt√© pour t√©l√©charger depuis une URL et forcer le lockscreen
# Scritp r√©cup√©re image et affiche en fond d'√©cran verrouillage (pas fond ecran windows)

param(
    [string]$ImageUrl = "https://url/tools/screen.png",
    [string]$LogPath = "$env:TEMP"
)

#Requires -RunAsAdministrator

# Logging
if (-not [string]::IsNullOrWhiteSpace($LogPath)) {
    Start-Transcript -Path "$($LogPath)\LockScreen_$($env:COMPUTERNAME)_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
}

$ErrorActionPreference = "Stop"

Write-Host "=== SCRIPT LOCKSCREEN PROFESSIONNEL ===" -ForegroundColor Magenta
Write-Host "URL Source : $ImageUrl" -ForegroundColor Cyan
Write-Host "M√©thode : PersonalizationCSP + D√©sactivation Spotlight" -ForegroundColor Yellow

try {
    # 1. T√©l√©charger l'image
    Write-Host "`n1. T√©l√©chargement de l'image..." -ForegroundColor Yellow
    
    $TempImage = "$env:TEMP\lockscreen_download.jpg"
    $LockScreenImageValue = "C:\Windows\System32\LockScreen.jpg"
    
    Invoke-WebRequest -Uri $ImageUrl -OutFile $TempImage -UseBasicParsing
    Write-Host "‚úÖ Image t√©l√©charg√©e vers : $TempImage" -ForegroundColor Green
    
    # V√©rifier la taille du fichier
    $FileSize = (Get-Item $TempImage).Length
    Write-Host "Taille du fichier : $FileSize bytes" -ForegroundColor Cyan
    
    if ($FileSize -lt 1000) {
        throw "Fichier trop petit, probablement une erreur de t√©l√©chargement"
    }

    # 2. Copier l'image vers le dossier syst√®me
    Write-Host "`n2. Installation de l'image syst√®me..." -ForegroundColor Yellow
    
    # S'assurer que le dossier System32 est accessible
    if (-not (Test-Path "C:\Windows\System32")) {
        throw "Impossible d'acc√©der au dossier System32"
    }
    
    Copy-Item $TempImage $LockScreenImageValue -Force
    Write-Host "‚úÖ Image copi√©e vers : $LockScreenImageValue" -ForegroundColor Green
    
    # V√©rifier que la copie a r√©ussi
    if (-not (Test-Path $LockScreenImageValue)) {
        throw "√âchec de la copie vers System32"
    }
    
    $CopiedSize = (Get-Item $LockScreenImageValue).Length
    Write-Host "Taille copi√©e : $CopiedSize bytes" -ForegroundColor Cyan

    # 3. √âTAPE CRITIQUE : D√©sactiver Windows Spotlight AVANT de configurer PersonalizationCSP
    Write-Host "`n3. D√©sactivation de Windows Spotlight..." -ForegroundColor Yellow
    
    # D√©sactiver au niveau syst√®me via Group Policy
    $SpotlightPolicyPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CloudContent"
    if (-not (Test-Path $SpotlightPolicyPath)) {
        New-Item -Path $SpotlightPolicyPath -Force | Out-Null
    }
    
    $SpotlightPolicies = @{
        "DisableWindowsSpotlightFeatures" = 1
        "DisableWindowsSpotlightOnActionCenter" = 1
        "DisableWindowsSpotlightOnSettings" = 1
        "DisableWindowsSpotlightWindowsWelcomeExperience" = 1
        "DisableSoftLanding" = 1
    }
    
    foreach ($policy in $SpotlightPolicies.GetEnumerator()) {
        Set-ItemProperty -Path $SpotlightPolicyPath -Name $policy.Key -Value $policy.Value -Type DWORD -Force
        Write-Host "Policy $($policy.Key) = $($policy.Value)" -ForegroundColor Gray
    }
    
    Write-Host "‚úÖ Windows Spotlight d√©sactiv√© au niveau syst√®me" -ForegroundColor Green

    # 4. Configuration PersonalizationCSP (m√©thode professionnelle)
    Write-Host "`n4. Configuration PersonalizationCSP..." -ForegroundColor Yellow
    
    $RegKeyPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"
    $LockScreenPath = "LockScreenImagePath"
    $LockScreenStatus = "LockScreenImageStatus"
    $LockScreenUrl = "LockScreenImageUrl"
    $StatusValue = "1"
    
    # Cr√©er la cl√© de registre si elle n'existe pas
    if (-not (Test-Path $RegKeyPath)) {
        Write-Host "Cr√©ation de la cl√© de registre $RegKeyPath"
        New-Item -Path $RegKeyPath -Force | Out-Null
    }
    
    # Configurer les valeurs de registre pour le lockscreen
    Write-Host "Configuration des entr√©es de registre pour Lock Screen..."
    
    New-ItemProperty -Path $RegKeyPath -Name $LockScreenStatus -Value $StatusValue -PropertyType DWORD -Force | Out-Null
    Write-Host "‚úì $LockScreenStatus = $StatusValue" -ForegroundColor Gray
    
    New-ItemProperty -Path $RegKeyPath -Name $LockScreenPath -Value $LockScreenImageValue -PropertyType STRING -Force | Out-Null
    Write-Host "‚úì $LockScreenPath = $LockScreenImageValue" -ForegroundColor Gray
    
    New-ItemProperty -Path $RegKeyPath -Name $LockScreenUrl -Value $LockScreenImageValue -PropertyType STRING -Force | Out-Null
    Write-Host "‚úì $LockScreenUrl = $LockScreenImageValue" -ForegroundColor Gray
    
    Write-Host "‚úÖ PersonalizationCSP configur√©" -ForegroundColor Green

    # 5. D√©sactiver Spotlight pour les utilisateurs existants
    Write-Host "`n5. Configuration utilisateurs..." -ForegroundColor Yellow
    
    # Obtenir tous les profils utilisateur
    $UserProfiles = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\*" | 
        Where-Object { $_.PSChildName -match "S-1-5-21" -and (Test-Path $_.ProfileImagePath) }
    
    foreach ($Profile in $UserProfiles) {
        try {
            $UserSID = $Profile.PSChildName
            $UserRegPath = "HKU:\$UserSID"
            
            # Charger la ruche utilisateur si n√©cessaire
            if (-not (Test-Path $UserRegPath)) {
                $NTUserPath = Join-Path $Profile.ProfileImagePath "NTUSER.DAT"
                if (Test-Path $NTUserPath) {
                    reg load "HKU\$UserSID" "`"$NTUserPath`"" 2>$null
                }
            }
            
            if (Test-Path $UserRegPath) {
                $UserCDMPath = "$UserRegPath\SOFTWARE\Microsoft\Windows\CurrentVersion\ContentDeliveryManager"
                if (-not (Test-Path $UserCDMPath)) {
                    New-Item -Path $UserCDMPath -Force | Out-Null
                }
                
                # D√©sactiver Spotlight pour cet utilisateur
                $SpotlightSettings = @{
                    "RotatingLockScreenEnabled" = 0
                    "RotatingLockScreenOverlayEnabled" = 0
                    "SubscribedContent-338387Enabled" = 0
                    "SubscribedContent-338393Enabled" = 0
                }
                
                foreach ($setting in $SpotlightSettings.GetEnumerator()) {
                    Set-ItemProperty -Path $UserCDMPath -Name $setting.Key -Value $setting.Value -Type DWORD -Force
                }
                
                Write-Host "‚úì Utilisateur $UserSID configur√©" -ForegroundColor Gray
            }
        }
        catch {
            Write-Host "‚ö†Ô∏è Erreur utilisateur $UserSID : $($_.Exception.Message)" -ForegroundColor Yellow
        }
    }
    
    Write-Host "‚úÖ Utilisateurs configur√©s" -ForegroundColor Green

    # 6. Forcer la mise √† jour des Group Policy
    Write-Host "`n6. Application des changements..." -ForegroundColor Yellow
    
    # Group Policy update
    Write-Host "Mise √† jour des Group Policy..."
    $GPResult = gpupdate /force 2>&1
    Write-Host "GP Update: $GPResult" -ForegroundColor Gray
    
    # Red√©marrer les services li√©s aux th√®mes
    $ServicesToRestart = @("Themes", "UxSms")
    foreach ($ServiceName in $ServicesToRestart) {
        try {
            $Service = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
            if ($Service -and $Service.Status -eq 'Running') {
                Restart-Service -Name $ServiceName -Force -ErrorAction SilentlyContinue
                Write-Host "‚úì Service $ServiceName red√©marr√©" -ForegroundColor Gray
            }
        }
        catch {
            Write-Host "‚ö†Ô∏è Service $ServiceName non red√©marrable" -ForegroundColor Yellow
        }
    }
    
    Write-Host "‚úÖ Services red√©marr√©s" -ForegroundColor Green

    # 7. V√©rifications finales
    Write-Host "`n7. V√©rifications finales..." -ForegroundColor Yellow
    
    # V√©rifier que l'image existe
    if (Test-Path $LockScreenImageValue) {
        $FinalSize = (Get-Item $LockScreenImageValue).Length
        Write-Host "‚úÖ Image finale pr√©sente : $LockScreenImageValue ($FinalSize bytes)" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Image finale absente !" -ForegroundColor Red
    }
    
    # V√©rifier les cl√©s de registre
    if (Test-Path $RegKeyPath) {
        $RegValues = Get-ItemProperty -Path $RegKeyPath
        Write-Host "‚úÖ Cl√©s de registre pr√©sentes :" -ForegroundColor Green
        Write-Host "   LockScreenImageStatus = $($RegValues.LockScreenImageStatus)" -ForegroundColor Gray
        Write-Host "   LockScreenImagePath = $($RegValues.LockScreenImagePath)" -ForegroundColor Gray
    }

    # 8. Instructions finales
    Write-Host "`nüéâ CONFIGURATION TERMIN√âE AVEC SUCC√àS !" -ForegroundColor Green
    Write-Host "`nüìã R√âSUM√â :" -ForegroundColor Yellow
    Write-Host "   ‚Ä¢ Image t√©l√©charg√©e depuis : $ImageUrl" -ForegroundColor White
    Write-Host "   ‚Ä¢ Image install√©e dans : $LockScreenImageValue" -ForegroundColor White  
    Write-Host "   ‚Ä¢ Windows Spotlight d√©sactiv√©" -ForegroundColor White
    Write-Host "   ‚Ä¢ PersonalizationCSP configur√©" -ForegroundColor White
    Write-Host "   ‚Ä¢ Group Policy appliqu√©es" -ForegroundColor White

    Write-Host "`nüß™ TESTS :" -ForegroundColor Magenta
    Write-Host "1. Testez imm√©diatement : Windows + L" -ForegroundColor White
    Write-Host "2. Si l'ancienne image persiste, attendez 2-3 minutes" -ForegroundColor White
    Write-Host "3. En dernier recours : red√©marrez l'ordinateur" -ForegroundColor White
    
    Write-Host "`nüí° D√âPANNAGE :" -ForegroundColor Cyan
    Write-Host "Si √ßa ne marche toujours pas :" -ForegroundColor White
    Write-Host "‚Ä¢ V√©rifiez dans Param√®tres > Personnalisation > √âcran de verrouillage" -ForegroundColor Gray
    Write-Host "‚Ä¢ Assurez-vous que 'Image' est s√©lectionn√© (pas 'Windows √† la une')" -ForegroundColor Gray
    Write-Host "‚Ä¢ L'image devrait √™tre automatiquement s√©lectionn√©e" -ForegroundColor Gray

} catch {
    Write-Host "`n‚ùå ERREUR : $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "D√©tails : $($_.Exception.GetType().FullName)" -ForegroundColor Red
    Write-Host "Ligne : $($_.InvocationInfo.ScriptLineNumber)" -ForegroundColor Red
    
    # En cas d'erreur, essayer de nettoyer
    if (Test-Path $TempImage) {
        Remove-Item $TempImage -Force -ErrorAction SilentlyContinue
    }
    
    throw
}

# Nettoyer les fichiers temporaires
if (Test-Path $TempImage) {
    Remove-Item $TempImage -Force -ErrorAction SilentlyContinue
}

if (-not [string]::IsNullOrWhiteSpace($LogPath)) {
    Stop-Transcript
}
